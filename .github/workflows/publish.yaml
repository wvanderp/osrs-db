name: Publish to npm

on:
  workflow_dispatch:
  # Automatically publish when a new release is created
  release:
    types:
      - published

jobs:
  publish:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      id-token: write
    steps:
      - name: ‚¨áÔ∏è Checkout repository
        uses: actions/checkout@v5
        with:
          # Fetch all history so we can create tags
          fetch-depth: 0
          # Use a PAT if needed for pushing tags
          token: ${{ secrets.GITHUB_TOKEN }}
          lfs: true

      - name: üü¢ Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "24"
          registry-url: "https://registry.npmjs.org"

      - name: üì¶ Install dependencies
        run: npm install

      - name: üî¢ Update version from cache number
        run: node scripts/update-version.mjs

      - name: üìù Get version for tagging
        id: get_version
        run: |
          VERSION=$(node -p "require('./package.json').version")
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "Version: $VERSION"

      - name: üîç Check if version already published
        id: check_version
        run: |
          PUBLISHED=$(npm view osrs-db@${{ steps.get_version.outputs.version }} version 2>/dev/null || echo "")
          if [ -n "$PUBLISHED" ]; then
            echo "skip=true" >> $GITHUB_OUTPUT
            echo "Version ${{ steps.get_version.outputs.version }} already published to npm"
          else
            echo "skip=false" >> $GITHUB_OUTPUT
            echo "Version ${{ steps.get_version.outputs.version }} not yet published"
          fi

      - name: üè∑Ô∏è Create and push git tag
        if: steps.check_version.outputs.skip != 'true'
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          TAG_NAME="v${{ steps.get_version.outputs.version }}"
          if git rev-parse "$TAG_NAME" >/dev/null 2>&1; then
            echo "Tag $TAG_NAME already exists, skipping tag creation"
          else
            git tag -a "$TAG_NAME" -m "Release version ${{ steps.get_version.outputs.version }}"
            git push origin "$TAG_NAME"
            echo "Created and pushed tag $TAG_NAME"
          fi

      - name: üöÄ Publish to npm
        if: steps.check_version.outputs.skip != 'true'
        run: npm publish --provenance --access public
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}

      - name: ‚úÖ Publish complete
        if: steps.check_version.outputs.skip != 'true'
        run: |
          echo "Successfully published version ${{ steps.get_version.outputs.version }} to npm"
          echo "Package: https://www.npmjs.com/package/osrs-db"

      - name: ‚è≠Ô∏è Version already published
        if: steps.check_version.outputs.skip == 'true'
        run: |
          echo "Version ${{ steps.get_version.outputs.version }} is already published to npm"
          echo "Skipping publish step"
